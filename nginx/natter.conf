# Natter API - Nginx Reverse Proxy con Rate Limiting
# Posiziona questo file in /etc/nginx/sites-available/natter.conf
# Poi crea symlink: ln -s /etc/nginx/sites-available/natter.conf /etc/nginx/sites-enabled/

# ============================================
# RATE LIMITING ZONES
# ============================================

# Zona 1: Rate limit generale per IP (protegge da flooding)
# 10MB di memoria = ~160k indirizzi IP tracciabili
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=100r/m;

# Zona 2: Rate limit per creazione utenti (più restrittivo)
limit_req_zone $binary_remote_addr zone=user_creation_limit:10m rate=5r/m;

# Zona 3: Rate limit per login (prevenzione brute force)
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=10r/m;

# Zona 4: Connection limit per IP (max connessioni simultanee)
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ============================================
# UPSTREAM (Backend Fastify)
# ============================================

upstream natter_backend {
    # Se hai più istanze dell'app, aggiungi qui (load balancing)
    server 127.0.0.1:3000 max_fails=3 fail_timeout=30s;
    # server 127.0.0.1:3001 max_fails=3 fail_timeout=30s;
    # server 127.0.0.1:3002 max_fails=3 fail_timeout=30s;

    keepalive 32; # Mantieni connessioni persistenti
}

# ============================================
# SERVER BLOCK
# ============================================

server {
    listen 80;
    listen [::]:80;
    server_name api.natter.local localhost;  # Modifica con il tuo dominio

    # Log separati per l'API
    access_log /var/log/nginx/natter-access.log;
    error_log /var/log/nginx/natter-error.log warn;

    # Limite connessioni simultanee per IP
    limit_conn conn_limit 10;

    # Security headers (defense in depth - anche se Fastify li aggiunge)
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "0" always;
    add_header Referrer-Policy "no-referrer" always;

    # Nascondi versione Nginx (security by obscurity - minimo aiuto)
    server_tokens off;

    # Body size limit (prevenzione upload massicci)
    client_max_body_size 1M;

    # Timeout configurazioni
    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 15;
    send_timeout 10;

    # ============================================
    # LOCATION: Health check (no rate limit)
    # ============================================
    location = /health {
        access_log off;  # Non loggare health checks
        proxy_pass http://natter_backend/;
        proxy_http_version 1.1;
    }

    # ============================================
    # LOCATION: User creation (rate limit restrittivo)
    # ============================================
    location = /users {
        # Applica rate limit: max 5 req/min, burst di 2 richieste extra
        limit_req zone=user_creation_limit burst=2 nodelay;

        # Se rate limit superato, restituisci 429 con retry-after header
        limit_req_status 429;

        proxy_pass http://natter_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # ============================================
    # LOCATION: Login endpoint (futuro)
    # ============================================
    location = /login {
        limit_req zone=login_limit burst=3 nodelay;
        limit_req_status 429;

        proxy_pass http://natter_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ============================================
    # LOCATION: Tutti gli altri endpoint (rate limit generale)
    # ============================================
    location / {
        # Rate limit generale: 100 req/min, burst di 20 richieste extra
        limit_req zone=general_limit burst=20 nodelay;
        limit_req_status 429;

        proxy_pass http://natter_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Timeout per il backend
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================
    # LOCATION: Blocca accesso a file sensibili
    # ============================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================
# SERVER BLOCK: HTTPS (produzione)
# ============================================
# Decommenta per usare HTTPS con certificato SSL/TLS

# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name api.natter.com;
#
#     # Certificati SSL (usa Let's Encrypt con certbot)
#     ssl_certificate /etc/letsencrypt/live/api.natter.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/api.natter.com/privkey.pem;
#
#     # SSL configurazione moderna (Mozilla Intermediate)
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
#     ssl_prefer_server_ciphers off;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#     ssl_stapling on;
#     ssl_stapling_verify on;
#
#     # HSTS (forza HTTPS per 1 anno)
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#
#     # Resto della configurazione identica al blocco HTTP
#     # ... (copia tutto dal server block sopra)
# }

# Redirect HTTP -> HTTPS (decommentare in produzione)
# server {
#     listen 80;
#     listen [::]:80;
#     server_name api.natter.com;
#     return 301 https://$server_name$request_uri;
# }
